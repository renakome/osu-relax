name: Build Android (signed debug) and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: microsoft
        java-version: 11

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "8.0.x"

    - name: Install .NET Android workload
      run: dotnet workload install android

    - name: Restore
      run: dotnet restore osu.Android\osu.Android.csproj

    - name: Build Release (Android)
      run: dotnet build osu.Android\osu.Android.csproj -c Release

    - name: Find main APK
      id: find_apks
      shell: pwsh
      run: |
        Write-Host "Looking for main osu! lazer APK..."

        # Look specifically for the main APK in the expected location
        $mainApkPath = "osu.Android\bin\Release\net8.0-android\sh.ppy.osulazer.apk"

        if (Test-Path $mainApkPath) {
          Write-Host "Found main APK: $mainApkPath"
          $apkPaths = @($mainApkPath)
        } else {
          Write-Host "Main APK not found at expected location: $mainApkPath"
          Write-Host "Searching for any sh.ppy.osulazer.apk files..."
          $foundApks = Get-ChildItem -Path "*sh.ppy.osulazer.apk" -Recurse -File -ErrorAction SilentlyContinue

          if ($foundApks -and $foundApks.Count -gt 0) {
            $apkPaths = $foundApks | Where-Object { $_.Name -eq "sh.ppy.osulazer.apk" } | Select-Object -ExpandProperty FullName
            Write-Host "Found main APK(s):"
            $apkPaths | ForEach-Object { Write-Host "  $_" }
          } else {
            Write-Host "No sh.ppy.osulazer.apk found. Listing all APK files for debug:"
            Get-ChildItem -Path "*.apk" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 10 | ForEach-Object { Write-Host "  $($_.FullName)" }
            exit 1
          }
        }

        "apk_path=$($apkPaths[0])" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Create GitHub Release and upload APK
      uses: ncipollo/release-action@v1
      with:
        tag: android-build-${{ github.run_number }}-r${{ github.run_id }}
        name: Android build ${{ github.run_number }} (run ${{ github.run_id }})
        body: Automated Android build from Actions.
        draft: false
        prerelease: true
        artifacts: ${{ steps.find_apks.outputs.apk_path }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
