name: Build Android (signed debug) and Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: microsoft
        java-version: 11

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "8.0.x"

    - name: Install .NET Android workload
      run: dotnet workload install android

    - name: Restore
      run: dotnet restore osu.Android.slnf

    - name: Build Release (Android)
      run: dotnet build -c Release osu.Android.slnf

    - name: Find produced APK(s)
      id: find_apks
      shell: pwsh
      run: |
        # Try multiple possible APK locations
        $apkPatterns = @(
          "**/bin/Release/**/*.apk",
          "**/bin/**/*.apk"
        )

        $apks = @()
        foreach ($pattern in $apkPatterns) {
          try {
            $found = Get-ChildItem -Path $pattern -Recurse -File -ErrorAction SilentlyContinue | Where-Object { $_.Extension -eq '.apk' }
            if ($found -and $found.Count -gt 0) {
              $apks += $found
              Write-Host "Found $($found.Count) APK(s) with pattern '$pattern'"
            }
          } catch {
            Write-Host "Error with pattern '$pattern': $_"
          }
        }

        # Remove duplicates and filter to actual APK files
        $apks = $apks | Sort-Object -Property FullName -Unique | Where-Object { $_.Extension -eq '.apk' }

        if (-not $apks -or $apks.Count -eq 0) {
          Write-Host "No APKs found. Listing all directories with 'Release' in path for debug:"
          Get-ChildItem -Recurse -Directory | Where-Object { $_.FullName -like "*Release*" } | Select-Object -First 10

          Write-Host "Listing all APK files in workspace:"
          Get-ChildItem -Path "*.apk" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 20

          exit 1
        }

        $apkPaths = $apks | Select-Object -ExpandProperty FullName
        Write-Host "Found $($apks.Count) APK(s) total:"
        $apkPaths | ForEach-Object { Write-Host "  $_" }

        "apk_files<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        $apkPaths | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Prepare debug keystore
      run: |
        # Usa secret DEBUG_KEYSTORE_BASE64 se existir (recomendado para chave persistente)
        if [ -n "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" ]; then
          echo "Using provided DEBUG_KEYSTORE_BASE64 secret..."
          echo "${{ secrets.DEBUG_KEYSTORE_BASE64 }}" | base64 -d > debug.keystore
        else
          echo "No DEBUG_KEYSTORE_BASE64 secret found â€” generating debug.keystore on-the-fly..."
          keytool -genkeypair -v \
            -keystore debug.keystore \
            -storepass android -keypass android \
            -alias androiddebugkey \
            -dname "CN=Android Debug,O=Android,C=US" \
            -keyalg RSA -keysize 2048 -validity 10000
        fi
        ls -lah debug.keystore

    - name: Download uber-apk-signer
      run: |
        Invoke-WebRequest -Uri "https://github.com/patrickfav/uber-apk-signer/releases/download/v1.2.1/uber-apk-signer-1.2.1.jar" -OutFile "uber-apk-signer.jar"
        java -version

    - name: Sign APK(s) with debug keystore
      shell: pwsh
      run: |
        $apkFiles = "${{ steps.find_apks.outputs.apk_files }}".Split("`n")
        foreach ($apk in $apkFiles) {
          if (-not [string]::IsNullOrWhiteSpace($apk)) {
            Write-Host "Signing: $apk"
            & java -jar uber-apk-signer.jar --apks "$apk" --ks debug.keystore --ks-key-alias androiddebugkey --ks-pass pass:android --key-pass pass:android --allowResign
          }
        }

    - name: Collect signed APKs
      id: collect_signed
      shell: pwsh
      run: |
        # Look for signed APKs (aligned.apk files created by uber-apk-signer)
        $signedPatterns = @(
          "**/*aligned.apk",
          "**/*-Signed.apk",
          "**/signed/**/*.apk"
        )

        $signed = @()
        foreach ($pattern in $signedPatterns) {
          try {
            $found = Get-ChildItem -Path $pattern -Recurse -File -ErrorAction SilentlyContinue | Where-Object { $_.Extension -eq '.apk' }
            if ($found -and $found.Count -gt 0) {
              $signed += $found
              Write-Host "Found $($found.Count) signed APK(s) with pattern '$pattern'"
            }
          } catch {
            Write-Host "Error with pattern '$pattern': $_"
          }
        }

        # Remove duplicates and filter to actual APK files
        $signed = $signed | Sort-Object -Property FullName -Unique | Where-Object { $_.Extension -eq '.apk' }

        if (-not $signed -or $signed.Count -eq 0) {
          Write-Host "No signed APKs found. Listing all APK files for debug:"
          Get-ChildItem -Path "*.apk" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 20
          exit 1
        }

        $signedPaths = $signed | Select-Object -ExpandProperty FullName
        Write-Host "Found $($signed.Count) signed APK(s) total:"
        $signedPaths | ForEach-Object { Write-Host "  $_" }

        "signed_apks<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        $signedPaths | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Create GitHub Release and upload signed APK(s)
      uses: ncipollo/release-action@v1
      with:
        tag: android-build-${{ github.run_number }}-r${{ github.run_id }}
        name: Android build ${{ github.run_number }} (run ${{ github.run_id }})
        body: Automated Android build (signed debug) from Actions.
        draft: false
        prerelease: true
        artifacts: "**/signed/*.apk,**/*aligned.apk"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Final cleanup
      if: always()
      shell: pwsh
      run: |
        Write-Host "Final cleanup"

        # Remove debug keystore and signing tools
        Remove-Item -Path "debug.keystore", "uber-apk-signer.jar" -ErrorAction SilentlyContinue

        # Remove any remaining build artifacts
        Get-ChildItem -Path "*.tmp", "*.log" -Recurse -File -ErrorAction SilentlyContinue | Remove-Item -Force

        Write-Host "Cleanup completed"
